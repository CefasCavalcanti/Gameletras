<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Letrinhas e N√∫meros M√°gicos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700;800&family=Nunito:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --sky-1:#9be7ff;
    --sky-2:#d5f9ff;
    --card:#ffffff;
    --ink:#1f375b;
    --accent:#ff7a59;
    --accent-2:#00b894;
    --accent-3:#ffd166;
    --accent-4:#4d96ff;
    --ok:#27c26c;
    --muted:#bcd3ea;
    --ring:#ffc857;
    --shadow:0 12px 28px rgba(32, 94, 153, .18);
  }

  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

  body{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    background:
      radial-gradient(circle at 12% 18%, rgba(255,255,255,.65) 0, rgba(255,255,255,0) 30%),
      radial-gradient(circle at 88% 10%, rgba(255,255,255,.55) 0, rgba(255,255,255,0) 28%),
      linear-gradient(165deg, var(--sky-1) 0%, var(--sky-2) 55%, #e9fbff 100%);
    padding:12px;
    overflow:hidden;
    font-family:"Baloo 2", system-ui, sans-serif;
    color:var(--ink);
    touch-action:none;
  }

  body::before,
  body::after{
    content:"";
    position:fixed;
    z-index:-1;
    border-radius:999px;
    filter:blur(2px);
    opacity:.35;
    pointer-events:none;
  }
  body::before{
    width:180px;height:180px;
    left:-36px;top:60px;
    background:linear-gradient(140deg,#ffb3c8,#ffd9a8);
    animation:floaty 5s ease-in-out infinite;
  }
  body::after{
    width:220px;height:220px;
    right:-54px;bottom:24px;
    background:linear-gradient(140deg,#9bf6ff,#b8f2e6);
    animation:floaty 6.2s ease-in-out infinite reverse;
  }

  @keyframes floaty{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-10px)}
  }

  .app{
    width:100%;
    max-width:460px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .top-card,
  .status-card,
  #canvas-container,
  #ui{
    background:var(--card);
    border:3px solid #dbebfb;
    border-radius:22px;
    box-shadow:var(--shadow);
  }

  .top-card{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .title-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  h1{
    font-size:1.45rem;
    line-height:1.05;
    color:#124b82;
  }

  .kid-pill{
    background:#fff6d6;
    border:2px solid #ffe8a3;
    padding:5px 10px;
    border-radius:999px;
    font-size:.95rem;
    font-weight:800;
    color:#7b4c08;
    white-space:nowrap;
  }

  .mode-switch{
    display:flex;
    gap:8px;
    background:#f2f8ff;
    padding:6px;
    border-radius:999px;
  }

  .mode-btn{
    border:none;
    background:transparent;
    color:#6788ad;
    font-weight:800;
    font-size:1rem;
    padding:8px 14px;
    border-radius:999px;
    cursor:pointer;
    min-width:86px;
  }
  .mode-btn.active{color:#fff;background:linear-gradient(120deg,#1cb0f6,#4d96ff)}

  .status-card{
    padding:10px 12px;
    display:grid;
    gap:8px;
  }

  .stats-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
  }

  .stat{
    background:#f6fbff;
    border:2px solid #d9ebfb;
    border-radius:14px;
    padding:6px 8px;
    text-align:center;
  }
  .stat strong{display:block;font-size:1.12rem;line-height:1.05;color:#0f5fa8}
  .stat span{font-family:"Nunito",sans-serif;font-size:.78rem;color:#476a91}

  .progress-wrap{
    width:100%;
    height:12px;
    background:#e3effa;
    border-radius:999px;
    overflow:hidden;
    border:1px solid #d0e4f7;
  }
  .progress-fill{
    width:0;
    height:100%;
    background:linear-gradient(90deg,#2ecc71,#6adf9a);
    transition:width .25s ease;
  }

  .meta-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    font-family:"Nunito",sans-serif;
    font-size:.84rem;
    color:#4f6e8f;
  }

  .mascot-row{
    display:flex;
    align-items:center;
    gap:10px;
    background:linear-gradient(130deg,#fff4cc,#ffe7e7);
    border:2px dashed #ffc9b8;
    border-radius:14px;
    padding:8px 10px;
  }
  .mascot-emoji{font-size:2rem;line-height:1}
  .mascot-text{font-size:1.02rem;font-weight:800;color:#8f3f2b}

  #canvas-container{
    position:relative;
    width:100%;
    min-height:310px;
    flex:1;
    overflow:hidden;
    touch-action:none;
    border-color:#bee0ff;
  }

  canvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;outline:none;}
  #overlay{pointer-events:none;}

  .badge-next{
    position:absolute;
    top:10px;
    left:10px;
    background:#ffffffd9;
    border:2px solid #e4eef9;
    border-radius:999px;
    padding:4px 10px;
    font-size:1rem;
    font-weight:800;
    color:#1c5d98;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    z-index:2;
  }
  .badge-next span{color:var(--accent)}

  #ui{
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}

  button{
    padding:10px 14px;
    border:none;
    border-radius:14px;
    font-weight:800;
    font-size:.98rem;
    background:#fff;
    color:var(--ink);
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,.07);
    transition:transform .09s ease, filter .09s ease;
    font-family:"Baloo 2",sans-serif;
  }
  button:active{transform:translateY(1px) scale(.98)}

  .btn-clear{background:#ffe8e8;color:#c0392b}
  .btn-brush{background:#e5f3ff;color:#1e5f9b}
  .btn-support{background:#fff8da;color:#8a6200}

  #scroll-wrap{width:100%;mask-image:linear-gradient(to right, transparent, black 10%, black 90%, transparent)}
  #alphabet{
    display:flex;
    gap:9px;
    overflow-x:auto;
    padding:8px 44%;
    scrollbar-width:none;
    scroll-snap-type:x mandatory;
  }
  #alphabet::-webkit-scrollbar{display:none}
  #alphabet button{
    min-width:52px;
    height:52px;
    font-size:1.25rem;
    border:2px solid #d7e7f7;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    scroll-snap-align:center;
    flex-shrink:0;
    background:#fff;
    color:#265c93;
  }
  #alphabet button.active{
    background:linear-gradient(120deg,#ff8b6a,#ffb364);
    border-color:#ff8b6a;
    color:#fff;
    transform:scale(1.08);
    box-shadow:0 8px 16px rgba(255,139,106,.28);
  }
  #alphabet button.mastered{
    border-color:#57ce8e;
    box-shadow:inset 0 0 0 2px rgba(87,206,142,.25);
  }

  .motivation{
    text-align:center;
    font-size:.9rem;
    color:#54769c;
    font-family:"Nunito",sans-serif;
    min-height:20px;
  }

  @media (max-height:700px){
    #canvas-container{min-height:270px}
    h1{font-size:1.25rem}
  }
</style>
</head>

<body>
<div class="app">
  <header class="top-card">
    <div class="title-row">
      <h1>Letrinhas e N√∫meros M√°gicos</h1>
      <div class="kid-pill" id="today-label">Miss√£o do dia</div>
    </div>
    <div class="mode-switch">
      <button class="mode-btn active" id="mode-abc" type="button">ABC</button>
      <button class="mode-btn" id="mode-123" type="button">123</button>
    </div>
  </header>

  <section class="status-card" aria-label="Progresso da crian√ßa">
    <div class="stats-grid">
      <div class="stat"><strong id="stars-count">0</strong><span>Estrelas</span></div>
      <div class="stat"><strong id="streak-count">0</strong><span>Sequ√™ncia</span></div>
      <div class="stat"><strong id="mastery-count">0%</strong><span>Dom√≠nio</span></div>
    </div>
    <div class="progress-wrap"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="meta-row">
      <span id="progress-text">0 de 26 conclu√≠dos</span>
      <span id="next-label">Atual: A</span>
    </div>
    <div class="mascot-row">
      <div class="mascot-emoji" id="mascot-emoji">üêù</div>
      <div class="mascot-text" id="mascot-text">A de Abelha</div>
    </div>
  </section>

  <div id="canvas-container">
    <div class="badge-next">Tra√ßar: <span id="trace-label">A</span></div>
    <canvas id="canvas"></canvas>
    <canvas id="overlay"></canvas>
  </div>

  <div id="ui">
    <div class="row">
      <button class="btn-brush" type="button" id="brush-thin">Fino</button>
      <button class="btn-brush" type="button" id="brush-mid">M√©dio</button>
      <button class="btn-brush" type="button" id="brush-thick">Grosso</button>
      <button class="btn-clear" type="button" id="btn-clear">Limpar</button>
    </div>
    <div class="row">
      <button class="btn-support" type="button" id="btn-hard">Revisar dif√≠ceis</button>
      <button class="btn-support" type="button" id="btn-reset-progress">Resetar progresso</button>
    </div>
    <div id="scroll-wrap">
      <div id="alphabet"></div>
    </div>
    <div class="motivation" id="encouragement">Voc√™ consegue. Vamos brincar aprendendo!</div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('canvas');
  const overlay = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  const ctxOver = overlay.getContext('2d');
  const alphabetEl = document.getElementById('alphabet');
  const nextLabel = document.getElementById('next-label');
  const traceLabel = document.getElementById('trace-label');
  const mascotEmojiEl = document.getElementById('mascot-emoji');
  const mascotTextEl = document.getElementById('mascot-text');
  const starsEl = document.getElementById('stars-count');
  const streakEl = document.getElementById('streak-count');
  const masteryEl = document.getElementById('mastery-count');
  const progressFillEl = document.getElementById('progress-fill');
  const progressTextEl = document.getElementById('progress-text');
  const encouragementEl = document.getElementById('encouragement');
  const todayLabelEl = document.getElementById('today-label');

  const COLOR_HINT   = '#deecfa';
  const COLOR_DONE   = '#27c26c';
  const COLOR_ACTIVE = '#ff7a59';
  const COLOR_START  = '#00b894';
  const COLOR_END    = '#ff5d73';

  const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const NUMBERS_1_100 = Array.from({length: 100}, (_, i) => String(i + 1));
  const STORAGE_KEY = 'letrinhas_game_progress_v1';

  const LETTER_HINTS = {
    A:{word:'Abelha',emoji:'üêù'}, B:{word:'Bola',emoji:'‚öΩ'}, C:{word:'Casa',emoji:'üè†'}, D:{word:'Dado',emoji:'üé≤'},
    E:{word:'Elefante',emoji:'üêò'}, F:{word:'Foca',emoji:'ü¶≠'}, G:{word:'Gato',emoji:'üê±'}, H:{word:'Helic√≥ptero',emoji:'üöÅ'},
    I:{word:'Igreja',emoji:'‚õ™'}, J:{word:'Jacar√©',emoji:'üêä'}, K:{word:'Kiwi',emoji:'ü•ù'}, L:{word:'Lua',emoji:'üåô'},
    M:{word:'Ma√ß√£',emoji:'üçé'}, N:{word:'Navio',emoji:'üö¢'}, O:{word:'Ovelha',emoji:'üêë'}, P:{word:'Pato',emoji:'ü¶Ü'},
    Q:{word:'Queijo',emoji:'üßÄ'}, R:{word:'Rato',emoji:'üê≠'}, S:{word:'Sapo',emoji:'üê∏'}, T:{word:'Tartaruga',emoji:'üê¢'},
    U:{word:'Uva',emoji:'üçá'}, V:{word:'Vaca',emoji:'üêÆ'}, W:{word:'Wi-fi',emoji:'üì∂'}, X:{word:'X√≠cara',emoji:'‚òï'},
    Y:{word:'Yoga',emoji:'üßò'}, Z:{word:'Zebra',emoji:'ü¶ì'}
  };

  const ENCOURAGEMENTS = [
    'Muito bem! Continue assim.',
    'Voc√™ est√° arrasando!',
    'Que tra√ßo bonito!',
    'Mais uma e ganhamos estrela!',
    'Aprender brincando √© divertido!',
    'Capricho total!'
  ];

  let mode = 'ABC';
  let list = LETTERS;
  let currentItem = 'A';
  let brushSize = 36;

  let strokes = [];
  let activeStrokeIndex = 0;
  let activePointIndex = 0;
  let isDrawing = false;
  let tPulse = 0;
  let selectedVoice = null;
  let audioCtx = null;
  let confetti = [];
  let attemptStarted = false;
  let attemptStartTs = 0;

  function todayIsoDate() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }

  function makeInitialProgress() {
    return {
      stars: 0,
      streakDays: 0,
      bestStreak: 0,
      lastPlayedDate: '',
      modeProgress: {
        ABC: {},
        '123': {}
      }
    };
  }

  function loadProgress() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return makeInitialProgress();
      const parsed = JSON.parse(raw);
      if (!parsed.modeProgress || !parsed.modeProgress.ABC || !parsed.modeProgress['123']) return makeInitialProgress();
      return parsed;
    } catch {
      return makeInitialProgress();
    }
  }

  let progress = loadProgress();

  function saveProgress() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
  }

  function ensureItemProgress(modeKey, item) {
    const bucket = progress.modeProgress[modeKey];
    if (!bucket[item]) {
      bucket[item] = {
        attempts: 0,
        completions: 0,
        bestMs: null,
        lastPlayedAt: 0
      };
    }
    return bucket[item];
  }

  function updateDailyStreak() {
    const today = todayIsoDate();
    const last = progress.lastPlayedDate;
    if (!last) {
      progress.streakDays = 1;
    } else {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yIso = yesterday.toISOString().slice(0, 10);
      if (last === today) {
        return;
      }
      if (last === yIso) {
        progress.streakDays += 1;
      } else {
        progress.streakDays = 1;
      }
    }
    progress.lastPlayedDate = today;
    progress.bestStreak = Math.max(progress.bestStreak || 0, progress.streakDays);
    saveProgress();
  }

  updateDailyStreak();
  todayLabelEl.textContent = `Dia ${progress.streakDays} seguido`;

  function loadVoices() {
    const voices = speechSynthesis.getVoices();
    selectedVoice =
      voices.find(v => v.name.includes('Google portugu√™s do Brasil')) ||
      voices.find(v => v.lang === 'pt-BR' && v.name.includes('Google')) ||
      voices.find(v => v.name.includes('Luciana')) ||
      voices.find(v => v.lang === 'pt-BR');
  }

  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
  }

  function speak(text) {
    if (!window.speechSynthesis) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(String(text));
    if (selectedVoice) u.voice = selectedVoice;
    u.lang = 'pt-BR';
    u.rate = 0.9;
    speechSynthesis.speak(u);
  }

  function playSound(freq, duration = 0.08) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.type = 'triangle';
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  function getLine(p1, p2) {
    const pts = [];
    const steps = 40;
    for(let i=0; i<=steps; i++) pts.push({ x: p1.x + (p2.x-p1.x)*(i/steps), y: p1.y + (p2.y-p1.y)*(i/steps) });
    return pts;
  }

  function getCurve(p1, cp, p2) {
    const pts = [];
    const steps = 50;
    for(let i=0; i<=steps; i++) {
      const t = i / steps;
      const x = Math.pow(1-t,2)*p1.x + 2*(1-t)*t*cp.x + Math.pow(t,2)*p2.x;
      const y = Math.pow(1-t,2)*p1.y + 2*(1-t)*t*cp.y + Math.pow(t,2)*p2.y;
      pts.push({x, y});
    }
    return pts;
  }

  function getStrokesForDigit(d, w, h, xOff=0, sW=w, pad=0) {
    const sX = (v) => xOff + pad + (v/100)*(sW - pad*2);
    const sY = (v) => pad + (v/100)*(h-pad*2);
    const p = (x,y) => ({ x: sX(x), y: sY(y) });
    const out = [];
    switch(d) {
      case '0': out.push([...getCurve(p(50,12),p(92,12),p(92,50)),...getCurve(p(92,50),p(92,88),p(50,88)),...getCurve(p(50,88),p(8,88),p(8,50)),...getCurve(p(8,50),p(8,12),p(50,12))]); break;
      case '1': out.push(getLine(p(42,25),p(55,12)), getLine(p(55,12),p(55,88)), getLine(p(35,88),p(75,88))); break;
      case '2': out.push(getCurve(p(18,30),p(50,2),p(82,30)), getLine(p(82,30),p(18,88)), getLine(p(18,88),p(82,88))); break;
      case '3': out.push(getCurve(p(22,20),p(60,6),p(82,26)), getCurve(p(82,26),p(60,50),p(40,50)), getCurve(p(40,50),p(92,52),p(82,80)), getCurve(p(82,80),p(55,96),p(22,84))); break;
      case '4': out.push(getLine(p(78,12),p(22,62)), getLine(p(22,62),p(88,62)), getLine(p(78,12),p(78,88))); break;
      case '5': out.push(getLine(p(82,14),p(28,14)), getLine(p(28,14),p(22,48)), getCurve(p(22,48),p(90,44),p(84,78)), getCurve(p(84,78),p(60,96),p(22,86))); break;
      case '6': out.push(getCurve(p(78,22),p(30,4),p(22,52)), getCurve(p(22,52),p(22,94),p(60,90)), getCurve(p(60,90),p(92,84),p(84,62)), getCurve(p(84,62),p(72,44),p(40,54))); break;
      case '7': out.push(getLine(p(20,14),p(84,14)), getLine(p(84,14),p(42,88))); break;
      case '8': out.push([...getCurve(p(50,50),p(20,40),p(20,25)),...getCurve(p(20,25),p(20,10),p(50,10)),...getCurve(p(50,10),p(80,10),p(80,25)),...getCurve(p(80,25),p(80,40),p(50,50)),...getCurve(p(50,50),p(20,60),p(20,75)),...getCurve(p(20,75),p(20,90),p(50,90)),...getCurve(p(50,90),p(80,90),p(80,75)),...getCurve(p(80,75),p(80,60),p(50,50))]); break;
      case '9': out.push(getCurve(p(78,50),p(78,16),p(42,16)), getCurve(p(42,16),p(12,16),p(18,40)), getCurve(p(18,40),p(26,66),p(56,58)), getLine(p(78,40),p(52,88))); break;
    }
    return out;
  }

  function getLetterStrokes(l, w, h) {
    const sX = (v) => (v/100)*w;
    const sY = (v) => (v/100)*h;
    const p = (x, y) => ({ x: sX(x), y: sY(y) });
    const d = [];
    switch(l) {
      case 'A': d.push(getLine(p(50, 15), p(20, 85)), getLine(p(50, 15), p(80, 85)), getLine(p(30, 60), p(70, 60))); break;
      case 'B': d.push(getLine(p(25,15),p(25,85)), [...getCurve(p(25,15),p(75,15),p(80,32)),...getCurve(p(80,32),p(75,50),p(25,50))], [...getCurve(p(25,50),p(85,50),p(85,68)),...getCurve(p(85,68),p(80,85),p(25,85))]); break;
      case 'C': d.push([...getCurve(p(80,20),p(80,10),p(50,10)),...getCurve(p(50,10),p(15,10),p(15,50)),...getCurve(p(15,50),p(15,90),p(50,90)),...getCurve(p(50,90),p(80,90),p(80,80))]); break;
      case 'D': d.push(getLine(p(28,15),p(28,85)), [...getCurve(p(28,15),p(85,15),p(85,50)),...getCurve(p(85,50),p(85,85),p(28,85))]); break;
      case 'E': d.push(getLine(p(28,15),p(28,85)), getLine(p(28,15),p(75,15)), getLine(p(28,50),p(65,50)), getLine(p(28,85),p(75,85))); break;
      case 'F': d.push(getLine(p(28,15),p(28,85)), getLine(p(28,15),p(75,15)), getLine(p(28,50),p(65,50))); break;
      case 'G': d.push([...getCurve(p(80,25),p(80,10),p(50,10)),...getCurve(p(50,10),p(15,10),p(15,50)),...getCurve(p(15,50),p(15,90),p(50,90)),...getCurve(p(50,90),p(80,90),p(80,55))], getLine(p(80,55),p(50,55))); break;
      case 'H': d.push(getLine(p(25,15),p(25,85)), getLine(p(75,15),p(75,85)), getLine(p(25,50),p(75,50))); break;
      case 'I': d.push(getLine(p(50,15),p(50,85))); break;
      case 'J': d.push(getLine(p(65,15),p(65,65)), getCurve(p(65,65),p(65,95),p(25,80))); break;
      case 'K': d.push(getLine(p(28,15),p(28,85)), getLine(p(75,15),p(28,50)), getLine(p(28,50),p(75,85))); break;
      case 'L': d.push(getLine(p(30,15),p(30,85)), getLine(p(30,85),p(75,85))); break;
      case 'M': d.push(getLine(p(20,85),p(20,15)), getLine(p(20,15),p(50,60)), getLine(p(50,60),p(80,15)), getLine(p(80,15),p(80,85))); break;
      case 'N': d.push(getLine(p(25,85),p(25,15)), getLine(p(25,15),p(75,85)), getLine(p(75,85),p(75,15))); break;
      case 'O': d.push([...getCurve(p(50,15),p(85,15),p(85,50)),...getCurve(p(85,50),p(85,85),p(50,85)),...getCurve(p(50,85),p(15,85),p(15,50)),...getCurve(p(15,50),p(15,15),p(50,15))]); break;
      case 'P': d.push(getLine(p(28,15),p(28,85)), [...getCurve(p(28,15),p(85,15),p(85,32)),...getCurve(p(85,32),p(85,50),p(28,50))]); break;
      case 'Q': d.push([...getCurve(p(50,15),p(85,15),p(85,50)),...getCurve(p(85,50),p(85,85),p(50,85)),...getCurve(p(50,85),p(15,85),p(15,50)),...getCurve(p(15,50),p(15,15),p(50,15))], getLine(p(60,60),p(85,85))); break;
      case 'R': d.push(getLine(p(28,15),p(28,85)), [...getCurve(p(28,15),p(85,15),p(85,32)),...getCurve(p(85,32),p(85,50),p(28,50))], getLine(p(45,50),p(80,85))); break;
      case 'S': d.push([...getCurve(p(78,28),p(78,12),p(50,12)),...getCurve(p(50,12),p(22,12),p(22,38)),...getCurve(p(22,38),p(22,50),p(50,50)),...getCurve(p(50,50),p(78,50),p(78,62)),...getCurve(p(78,62),p(78,88),p(50,88)),...getCurve(p(50,88),p(22,88),p(22,72))]); break;
      case 'T': d.push(getLine(p(20,15),p(80,15)), getLine(p(50,15),p(50,85))); break;
      case 'U': d.push([...getLine(p(25,15),p(25,60)),...getCurve(p(25,60),p(25,90),p(50,90)),...getCurve(p(50,90),p(75,90),p(75,60)),...getLine(p(75,60),p(75,15))]); break;
      case 'V': d.push(getLine(p(20,15),p(50,85)), getLine(p(50,85),p(80,15))); break;
      case 'W': d.push(getLine(p(15,15),p(30,85)), getLine(p(30,85),p(50,40)), getLine(p(50,40),p(70,85)), getLine(p(70,85),p(85,15))); break;
      case 'X': d.push(getLine(p(20,15),p(80,85)), getLine(p(80,15),p(20,85))); break;
      case 'Y': d.push(getLine(p(20,15),p(50,50)), getLine(p(80,15),p(50,50)), getLine(p(50,50),p(50,85))); break;
      case 'Z': d.push(getLine(p(20,15),p(80,15)), getLine(p(80,15),p(20,85)), getLine(p(20,85),p(80,85))); break;
    }
    return d;
  }

  function buildStrokesForItem(item) {
    const w = canvas.width;
    const h = canvas.height;
    let raw = [];
    if (mode === 'ABC') {
      raw = getLetterStrokes(item, w, h);
    } else {
      const text = String(item);
      const digits = text.split('');
      const pad = Math.max(15, w * 0.06);
      const slotW = w / digits.length;
      digits.forEach((d, i) => raw.push(...getStrokesForDigit(d, w, h, i * slotW, slotW, pad)));
    }
    strokes = raw.map(pts => ({ points: pts, completed: false }));
    activeStrokeIndex = 0;
    activePointIndex = 0;
    isDrawing = false;
    attemptStarted = false;
  }

  function drawPath(pts, color, width) {
    if (pts.length < 2) return;
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(pts[0].x, pts[0].y);
    pts.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.stroke();
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    strokes.forEach(s => drawPath(s.points, COLOR_HINT, brushSize));
    strokes.forEach((s, idx) => {
      if (s.completed) {
        drawPath(s.points, COLOR_DONE, brushSize);
      } else if (idx === activeStrokeIndex) {
        drawPath(s.points.slice(0, activePointIndex), COLOR_ACTIVE, brushSize);
        const start = s.points[0];
        const end = s.points[s.points.length - 1];
        const current = s.points[activePointIndex];

        ctx.beginPath();
        ctx.arc(start.x, start.y, brushSize / 1.9, 0, Math.PI * 2);
        ctx.fillStyle = COLOR_START;
        ctx.fill();

        ctx.beginPath();
        ctx.arc(end.x, end.y, brushSize / 1.65, 0, Math.PI * 2);
        ctx.lineWidth = 4;
        ctx.strokeStyle = COLOR_END;
        ctx.stroke();

        if (current) {
          const pulse = Math.sin(tPulse) * 5;
          ctx.beginPath();
          ctx.arc(current.x, current.y, brushSize / 2 + pulse, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(255,122,89,0.22)';
          ctx.fill();
        }
      }
    });
    stepConfetti();
  }

  function spawnConfetti() {
    for (let i = 0; i < 70; i++) {
      confetti.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random()-0.5) * 12,
        vy: (Math.random() * -1) * 12 - 3,
        g: 0.34,
        r: Math.random() * Math.PI,
        vr: (Math.random()-0.5) * 0.2,
        s: Math.random() * 8 + 4,
        c: ['#ff7a59','#ffd166','#00b894','#4d96ff'][Math.random()*4|0],
        life: 95
      });
    }
  }

  function stepConfetti() {
    ctxOver.clearRect(0,0,overlay.width,overlay.height);
    confetti.forEach((p) => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.r += p.vr;
      p.life--;
      ctxOver.save();
      ctxOver.translate(p.x, p.y);
      ctxOver.rotate(p.r);
      ctxOver.fillStyle = p.c;
      ctxOver.fillRect(-p.s/2, -p.s/2, p.s, p.s * 0.6);
      ctxOver.restore();
    });
    confetti = confetti.filter(p => p.life > 0);
  }

  function getXY(e) {
    const r = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return {
      x: (t.clientX - r.left) * (canvas.width / r.width),
      y: (t.clientY - r.top) * (canvas.height / r.height)
    };
  }

  function registerAttempt() {
    const itemProgress = ensureItemProgress(mode, currentItem);
    itemProgress.attempts += 1;
    itemProgress.lastPlayedAt = Date.now();
    saveProgress();
    refreshStats();
  }

  function registerCompletion() {
    const itemProgress = ensureItemProgress(mode, currentItem);
    itemProgress.completions += 1;
    itemProgress.lastPlayedAt = Date.now();

    if (attemptStarted && attemptStartTs) {
      const elapsed = Date.now() - attemptStartTs;
      if (!itemProgress.bestMs || elapsed < itemProgress.bestMs) {
        itemProgress.bestMs = elapsed;
      }
    }

    const earnedStars = Math.max(1, Math.min(3, Math.floor(12000 / Math.max(2500, Date.now() - attemptStartTs))));
    progress.stars += earnedStars;

    saveProgress();
    refreshStats();
    setEncouragement();
  }

  function getHintForCurrentItem() {
    if (mode === 'ABC') {
      const hint = LETTER_HINTS[currentItem] || {word: currentItem, emoji: '‚ú®'};
      return {
        emoji: hint.emoji,
        text: `${currentItem} de ${hint.word}`,
        voice: `${currentItem} de ${hint.word}`
      };
    }

    const n = Number(currentItem);
    if (n <= 5) {
      const bubble = 'üü†'.repeat(n);
      return {
        emoji: bubble || 'üü†',
        text: `${currentItem} bolinha${n > 1 ? 's' : ''}`,
        voice: `N√∫mero ${currentItem}`
      };
    }

    return {
      emoji: 'üî¢',
      text: `N√∫mero ${currentItem}`,
      voice: `N√∫mero ${currentItem}`
    };
  }

  function masteredRatio(modeKey, item) {
    const p = ensureItemProgress(modeKey, item);
    if (p.attempts === 0) return 0;
    return p.completions / p.attempts;
  }

  function updateMascotAndSpeech(playAudio = true) {
    const hint = getHintForCurrentItem();
    mascotEmojiEl.textContent = hint.emoji;
    mascotTextEl.textContent = hint.text;
    if (playAudio) speak(hint.voice);
  }

  function setEncouragement(custom) {
    if (custom) {
      encouragementEl.textContent = custom;
      return;
    }
    encouragementEl.textContent = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
  }

  function refreshStats() {
    const modeItems = mode === 'ABC' ? LETTERS : NUMBERS_1_100;
    let completed = 0;
    let attempts = 0;
    let completions = 0;

    modeItems.forEach(item => {
      const p = ensureItemProgress(mode, item);
      attempts += p.attempts;
      completions += p.completions;
      if (p.completions > 0) completed++;
    });

    const mastery = attempts > 0 ? Math.round((completions / attempts) * 100) : 0;
    const progressPct = Math.round((completed / modeItems.length) * 100);

    starsEl.textContent = String(progress.stars);
    streakEl.textContent = String(progress.streakDays || 0);
    masteryEl.textContent = `${mastery}%`;
    progressFillEl.style.width = `${progressPct}%`;
    progressTextEl.textContent = `${completed} de ${modeItems.length} conclu√≠dos`;

    document.querySelectorAll('#alphabet button').forEach(btn => {
      const item = btn.dataset.item;
      const p = ensureItemProgress(mode, item);
      btn.classList.toggle('mastered', p.completions >= 2 || masteredRatio(mode, item) >= 0.7);
    });
  }

  function selectItem(item, playAudio = true) {
    currentItem = String(item);
    nextLabel.textContent = `Atual: ${currentItem}`;
    traceLabel.textContent = currentItem;

    document.querySelectorAll('#alphabet button').forEach(b => {
      b.classList.toggle('active', b.dataset.item === currentItem);
      if (b.classList.contains('active')) b.scrollIntoView({behavior:'smooth', inline:'center'});
    });

    updateMascotAndSpeech(playAudio);
    buildStrokesForItem(currentItem);
    refreshStats();
  }

  function setMode(m) {
    mode = m;
    list = mode === 'ABC' ? LETTERS : NUMBERS_1_100;

    document.getElementById('mode-abc').classList.toggle('active', mode === 'ABC');
    document.getElementById('mode-123').classList.toggle('active', mode === '123');

    alphabetEl.innerHTML = '';
    list.forEach(it => {
      const b = document.createElement('button');
      b.textContent = it;
      b.dataset.item = it;
      b.onclick = () => selectItem(it);
      alphabetEl.appendChild(b);
    });

    selectItem(list[0], false);
    setEncouragement('Escolha um item e comece o tra√ßado.');
  }

  function pickDifficultItem() {
    const candidates = [...list].sort((a, b) => masteredRatio(mode, a) - masteredRatio(mode, b));
    const chosen = candidates.find(item => ensureItemProgress(mode, item).attempts > 0) || candidates[0];
    selectItem(chosen);
    setEncouragement('Vamos praticar o item mais dif√≠cil agora.');
  }

  function resetProgress() {
    progress = makeInitialProgress();
    updateDailyStreak();
    saveProgress();
    refreshStats();
    setMode(mode);
    setEncouragement('Progresso resetado. Nova jornada come√ßando!');
  }

  canvas.addEventListener('pointerdown', (e) => {
    const {x, y} = getXY(e);
    const startPt = strokes[activeStrokeIndex]?.points[0];
    if (startPt && Math.hypot(x-startPt.x, y-startPt.y) < brushSize * 2.8) {
      isDrawing = true;
      if (!attemptStarted) {
        attemptStarted = true;
        attemptStartTs = Date.now();
        registerAttempt();
      }
      playSound(390, 0.05);
    }
  });

  window.addEventListener('pointermove', (e) => {
    if (!isDrawing) return;
    const {x, y} = getXY(e);
    const s = strokes[activeStrokeIndex];
    if (!s) return;
    const target = s.points[activePointIndex];
    if (!target) return;

    if (Math.hypot(x-target.x, y-target.y) < brushSize * 2.2) {
      activePointIndex += 4;
      if (activePointIndex >= s.points.length) {
        s.completed = true;
        activeStrokeIndex++;
        activePointIndex = 0;
        playSound(620, 0.08);

        if (activeStrokeIndex >= strokes.length) {
          isDrawing = false;
          spawnConfetti();
          playSound(920, 0.22);
          registerCompletion();
          const next = list[(list.indexOf(currentItem) + 1) % list.length];
          setTimeout(() => selectItem(next), 1200);
        }
      }
    }
  });

  window.addEventListener('pointerup', () => isDrawing = false);

  function resize() {
    const r = canvas.getBoundingClientRect();
    canvas.width = overlay.width = r.width;
    canvas.height = overlay.height = r.height;
    buildStrokesForItem(currentItem);
  }

  document.getElementById('brush-thin').onclick = () => { brushSize = 22; draw(); setEncouragement('Pincel fino selecionado.'); };
  document.getElementById('brush-mid').onclick = () => { brushSize = 36; draw(); setEncouragement('Pincel m√©dio selecionado.'); };
  document.getElementById('brush-thick').onclick = () => { brushSize = 54; draw(); setEncouragement('Pincel grosso selecionado.'); };
  document.getElementById('btn-clear').onclick = () => { buildStrokesForItem(currentItem); setEncouragement('Tudo limpo. Tente de novo!'); };
  document.getElementById('mode-abc').onclick = () => setMode('ABC');
  document.getElementById('mode-123').onclick = () => setMode('123');
  document.getElementById('btn-hard').onclick = pickDifficultItem;
  document.getElementById('btn-reset-progress').onclick = resetProgress;

  function loop() {
    tPulse += 0.1;
    draw();
    requestAnimationFrame(loop);
  }

  window.onresize = resize;
  resize();
  setMode('ABC');
  refreshStats();
  loop();
})();
</script>
</body>
</html>
